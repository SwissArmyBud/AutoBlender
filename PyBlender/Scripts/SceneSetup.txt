import bpy, math, os, sys
from bpy import context
from math import sin, cos, pi
from mathutils import Vector, Quaternion
import time


socketID = sys.argv[6]
frameSkip = int(sys.argv[7])

def sout(input):
	print(input)
	sys.stdout.flush()
	time.sleep(.1)


# sout("   **TRYING TO ADD MUSIC**")
# scene = context.scene
# if not scene.sequence_editor:
# 	scene.sequence_editor_create()
# scene.sequence_editor.sequences.new_sound("song", "Website/uploads/" + socketID + ".mp3", 1, 1)
# time.sleep(2)


# let the user know Blender is working
#
sout("")
sout("")
sout("     Blender is now working!      ")
sout("----------------------------------")
sout("")

# open and load the beat times information
#
beatData = []
beatFile = open('./Website/downloads/' + socketID + '.bts','r')
for line in beatFile.readlines():
		beatData.extend(line.split())
beatFile.close()

beatFrames = []
beats = 0
for i in range(len(beatData)):
    tmp = beatData[i]
    beatFrames.append(int(float(tmp)))

sout("Beats Finished Importing")
sout("->Beats: " + str(len(beatData)))
sout("")

# open and load the mel volume information
#
volumeData = []
volumeFile = open('./Website/downloads/' + socketID + '.vol','r')
for line in volumeFile.readlines():
    volumeData.extend(line.split())
volumeFile.close()

# open and load mel information
#
MelData = []
melFile = open('./Website/downloads/' + socketID + '.mel','r')
for line in melFile.readlines():
    MelData.append(line.split())
melFile.close()

maxFrames = len(MelData)
melBins = len(MelData[0])

sout("Mel Finished Importing")
sout("->Frames: " + str(maxFrames))
sout("->Bins: " + str(melBins))
sout("")

# setup some basic parameters before creating/animating objects
#
scn = bpy.context.scene
scn.frame_end = maxFrames

origin = Vector().zero()
meshLoc = Vector().zero()

sout("Frames traveled per keyframe: " + str(frameSkip))
sout("")
sout("***** ANIMATION STARTED *****")
sout("")

#
#	ATTENTION: THIS ENDS THE SCENE SETUP AREA
#
#	THE REST OF THE TOOL CHAIN IS SIMPLY A RENDERING SCRIPT, AKA "CORE"
#	AND CAN NOW BE REPLACED, MODIFIED, OR REIMPLIMENTED AT WILL
#
