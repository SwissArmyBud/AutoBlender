
<script src="/socket.io/socket.io.js"></script>

<script>
var socket = io();
socket.on('connect', function(){console.log("Connected to socketIO!");});

var audioShellTag = "PyBlender> ";
var audioConsole = audioShellTag;
var updateAudioConsole = function(text){
  text.replace("\r", "<br/>" + audioShellTag);
  audioConsole += text + "<br/>" + audioShellTag;
  $("#fileProcessingProgress").html(audioConsole);
}

var renderShellTag = "BlenderEngine> ";
var blenderConsole = renderShellTag;
var updateBlenderConsole = function(text){
  text.replace("\r", "<br/>" + renderShellTag);
  blenderConsole += text + "<br/>" + renderShellTag;
  $("#blenderRenderingProgress").html(blenderConsole);
}

socket.on("uploadStatus", function(data){
  switch(data.status){
    // UPLOAD DONE
    case("::UPD"):{
      console.log("Incoming status update:");
      console.log(data);
      $("#fileProcessingProgress").css("visibility", "visible");
      updateAudioConsole("Processing started...");
      break;
    }
    // PYTHON3 CHILD STATUS
    case("::PY3"):{
      console.log(data.stdout);
      updateAudioConsole(data.stdout);
      $("#fileProcessingProgress")[0].scrollTop = $("#fileProcessingProgress")[0].scrollHeight;
      break;
    }
    // PYTHON3 CHILD DONE
    case("::PYD"):{
      console.log("Incoming status update:");
      console.log(data);
      $("#blenderRenderingProgress").css("visibility", "visible");
      updateBlenderConsole("Rendering started...");
      break;
    }
    // BLENDER RENDERING ENGINE
    case("::BRE"):{
      console.log(data.stdout);
      updateBlenderConsole(data.stdout);
      $("#blenderRenderingProgress")[0].scrollTop = $("#blenderRenderingProgress")[0].scrollHeight;
      break;
    }
    // BLENDER RENDERING DONE
    case("::RDY"):{
      console.log("Files ready for download!");
      $("#downloadFileArea").css("visibility", "visible");
      $("#downloadFileArea").append($("<a/>").attr("href", "/" + socket.id + ".blend").text("DOWNLOAD"));
      break;
    }
  }
});
//socket.on('event', function(data){});
//socket.on('disconnect', function(){});

$(function(){
  console.log("JQuery loaded!");
  $("#fileInput").on('change', function(event){
    console.log("Change in file!");
    $("#uploadButton").css("visibility", "visible");
  }); // on file input change
  $("#uploadButton").click(function(event){
    event.preventDefault();
    console.log("Upload button clicked!");
    $("#socketID").val(socket.id);
    console.log($("#uploadForm"));
    console.log("Submitting form!");
    var formData = new FormData($("#uploadForm")[0]);
    $("#fileUploadProgress").css("visibility", "visible");
    $("#fileUploadProgress").append($("<div/>").attr("id", "progressText"));
    $.ajax({
      xhr: function()
      {
        var xhr = new window.XMLHttpRequest();
        //Upload progress
        xhr.upload.addEventListener("progress", function(evt){
          if (evt.lengthComputable) {
            var percentComplete = 100 * (evt.loaded / evt.total);
            $("#progressText").text(percentComplete);
            //Do something with upload progress
            console.log(percentComplete);
          }
        }, false);
        return xhr;
      },
      url: "/upload",
      type: 'POST',
      data: formData,
      success: function (data) {
        console.log("Finished upload!");
        console.log(data);
      },
      cache: false,
      contentType: false,
      processData: false
    }); // ajax process
  }); // upload button click


}); // jQuery ready
</script>
